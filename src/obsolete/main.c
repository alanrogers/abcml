#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>
#include <assert.h>
#include "mytypes.h"
#include "bone.h"
#define DATASET 1

#if DATASET==0
#define NAGENT 2    /* number of agents of deposition */
#define NPART  2    /* number of faunal elements */
real mm[NAGENT][NPART] = { /* Mean vectors */
  {/* agent 0 */ 0.3, 1.3},
  {/* agent 1 */ 0.7, 0.7}};

real FF[NAGENT][NPART][NPART] = { /*MSCP matrices */
{ /* agent 0 */
 {  /* part 0 */ 0.3, 0.4},
 {  /* part 1 */ 0.4, 2.0}},
{ /* agent 1 */
 {  /* part 0 */ 0.7, 0.5},
 {  /* part 1 */ 0.5, 0.8}}};

char *label[NPART] = {"skull", "femur"};

double density[NPART] = {
0.5,  /* skull */  
0.36  /* femur */
};

/* number of parts in a living animal */
int b[NPART] = {
  1 /*skull*/,
  2 /*femora*/};

#define NDATA 1
/* archeological data */
int yy[NDATA][NPART] = {{506, 926}} ; 

#else 
#define NAGENT 2    /* number of agents of deposition */
#define NPART  22   /* number of faunal elements */
double mm[2][22] = { /* Mean vectors */
 {/* agent 0 */ 1.29166666666666674068, 0.83333333333333370341,
1.66666666666666740682, 0.83333333333333370341,
1.58333333333333370341, 1.50000000000000044409,
1.50000000000000044409, 1.35416666666666651864,
1.35416666666666651864, 1.29166666666666674068,
1.29166666666666674068, 1.27083333333333325932,
1.27083333333333325932, 5.74999999999999822364, 5.125,
13.87499999999999822364, 1.29166666666666674068,
1.29166666666666674068, 17.375, 1.22916666666666651864,
1.20833333333333325932, 1.20833333333333325932}, 
 {/* agent 1 */ 0.70833333333333325932, 1.16666666666666629659,
0.33333333333333259318, 0.16666666666666629659,
0.41666666666666629659, 0.49999999999999955591,
0.49999999999999955591, 0.64583333333333348136,
0.64583333333333348136, 0.70833333333333325932,
0.70833333333333325932, 0.72916666666666674068,
0.72916666666666674068, -0.74999999999999822364, 0.875,
14.12500000000000177636, 0.70833333333333325932,
0.70833333333333325932, 6.625, 6.77083333333333392545,
0.79166666666666674068, 0.79166666666666674068}}; 

real FF[NAGENT][NPART][NPART] = { /*MSCP matrices */
{ /* agent 0 */
 {  /* part 0 */
 2.58333333333333348136, 1.25, 2.5,
 1.25, 2.33333333333333303727, 2.12499999999999911182,
 2.12499999999999911182, 1.91666666666666607455, 1.91666666666666607455,
 1.9166666666666658525, 1.9166666666666658525, 1.9166666666666658525,
 1.9166666666666658525, 8.58333333333333570181, 7.25,
 21.79166666666666429819, 1.87499999999999955591, 1.87499999999999955591,
 25.5, 1.9166666666666658525, 1.9166666666666658525,
 1.9166666666666658525},
 {  /* part 1 */
 1.25, 0.83333333333333370341, 1.54166666666666718477,
 0.77083333333333359239, 1.45833333333333370341, 1.33333333333333348136,
 1.33333333333333348136, 1.20833333333333303727, 1.20833333333333303727,
 1.16666666666666651864, 1.16666666666666651864, 1.1875,
 1.1875, 5.74999999999999822364, 4.75,
 13.54166666666666607455, 1.16666666666666651864, 1.16666666666666651864,
 16.125, 1.14583333333333325932, 1.12499999999999977796,
 1.12499999999999977796},
 {  /* part 2 */
 2.5, 1.54166666666666718477, 3.33333333333333481363,
 1.66666666666666740682, 2.83333333333333392545, 2.66666666666666696273,
 2.66666666666666696273, 2.37499999999999911182, 2.37499999999999911182,
 2.33333333333333303727, 2.33333333333333303727, 2.33333333333333303727,
 2.33333333333333303727, 10.62499999999999822364, 9.75,
 25.9583333333333321491, 2.24999999999999955591, 2.24999999999999955591,
 31.5, 2.24999999999999955591, 2.20833333333333303727,
 2.20833333333333303727},
 {  /* part 3 */
 1.25, 0.77083333333333359239, 1.66666666666666740682,
 0.83333333333333370341, 1.41666666666666696273, 1.33333333333333348136,
 1.33333333333333348136, 1.18749999999999955591, 1.18749999999999955591,
 1.16666666666666651864, 1.16666666666666651864, 1.16666666666666651864,
 1.16666666666666651864, 5.31249999999999911182, 4.875,
 12.97916666666666607455, 1.12499999999999977796, 1.12499999999999977796,
 15.75, 1.12499999999999977796, 1.10416666666666651864,
 1.10416666666666651864},
 {  /* part 4 */
 2.33333333333333303727, 1.45833333333333370341, 2.83333333333333392545,
 1.41666666666666696273, 3.0416666666666678509, 2.79166666666666740682,
 2.79166666666666740682, 2.54166666666666696273, 2.54166666666666696273,
 2.47916666666666696273, 2.47916666666666696273, 2.45833333333333348136,
 2.45833333333333348136, 10.06249999999999822364, 8.875,
 23.45833333333332859638, 2.47916666666666651864, 2.47916666666666651864,
 33.375, 2.375, 2.35416666666666651864,
 2.35416666666666651864},
 {  /* part 5 */
 2.12499999999999911182, 1.33333333333333348136, 2.66666666666666696273,
 1.33333333333333348136, 2.79166666666666740682, 2.95833333333333436954,
 2.95833333333333436954, 2.66666666666666696273, 2.66666666666666696273,
 2.5, 2.5, 2.5,
 2.5, 9.1875, 8.375,
 20, 2.54166666666666740682, 2.54166666666666740682,
 31.75, 2.41666666666666651864, 2.41666666666666651864,
 2.41666666666666651864},
 {  /* part 6 */
 2.12499999999999911182, 1.33333333333333348136, 2.66666666666666696273,
 1.33333333333333348136, 2.79166666666666740682, 2.95833333333333436954,
 2.95833333333333436954, 2.66666666666666696273, 2.66666666666666696273,
 2.5, 2.5, 2.5,
 2.5, 9.1875, 8.375,
 20, 2.54166666666666740682, 2.54166666666666740682,
 31.75, 2.41666666666666651864, 2.41666666666666651864,
 2.41666666666666651864},
 {  /* part 7 */
 1.91666666666666607455, 1.20833333333333303727, 2.37499999999999911182,
 1.18749999999999955591, 2.54166666666666696273, 2.66666666666666696273,
 2.66666666666666696273, 2.60416666666666740682, 2.60416666666666740682,
 2.37499999999999955591, 2.37499999999999955591, 2.35416666666666607455,
 2.35416666666666607455, 8.43750000000000355271, 7.5,
 18.27083333333333570181, 2.50000000000000044409, 2.50000000000000044409,
 30.25, 2.29166666666666607455, 2.29166666666666607455,
 2.29166666666666607455},
 {  /* part 8 */
 1.91666666666666607455, 1.20833333333333303727, 2.37499999999999911182,
 1.18749999999999955591, 2.54166666666666696273, 2.66666666666666696273,
 2.66666666666666696273, 2.60416666666666740682, 2.60416666666666740682,
 2.37499999999999955591, 2.37499999999999955591, 2.35416666666666607455,
 2.35416666666666607455, 8.43750000000000355271, 7.5,
 18.27083333333333570181, 2.50000000000000044409, 2.50000000000000044409,
 30.25, 2.29166666666666607455, 2.29166666666666607455,
 2.29166666666666607455},
 {  /* part 9 */
 1.9166666666666658525, 1.16666666666666651864, 2.33333333333333303727,
 1.16666666666666651864, 2.47916666666666696273, 2.5,
 2.5, 2.37499999999999955591, 2.37499999999999955591,
 2.5, 2.5, 2.41666666666666651864,
 2.41666666666666651864, 8.16666666666666962726, 7.5,
 18.8541666666666678509, 2.33333333333333303727, 2.33333333333333303727,
 29.375, 2.39583333333333303727, 2.375,
 2.375},
 {  /* part 10 */
 1.9166666666666658525, 1.16666666666666651864, 2.33333333333333303727,
 1.16666666666666651864, 2.47916666666666696273, 2.5,
 2.5, 2.37499999999999955591, 2.37499999999999955591,
 2.5, 2.5, 2.41666666666666651864,
 2.41666666666666651864, 8.16666666666666962726, 7.5,
 18.8541666666666678509, 2.33333333333333303727, 2.33333333333333303727,
 29.375, 2.39583333333333303727, 2.375,
 2.375},
 {  /* part 11 */
 1.9166666666666658525, 1.1875, 2.33333333333333303727,
 1.16666666666666651864, 2.45833333333333348136, 2.5,
 2.5, 2.35416666666666607455, 2.35416666666666607455,
 2.41666666666666651864, 2.41666666666666651864, 2.4375,
 2.4375, 8.31250000000000177636, 7.5,
 18.75000000000000355271, 2.29166666666666607455, 2.29166666666666607455,
 29.5, 2.375, 2.35416666666666651864,
 2.35416666666666651864},
 {  /* part 12 */
 1.9166666666666658525, 1.1875, 2.33333333333333303727,
 1.16666666666666651864, 2.45833333333333348136, 2.5,
 2.5, 2.35416666666666607455, 2.35416666666666607455,
 2.41666666666666651864, 2.41666666666666651864, 2.4375,
 2.4375, 8.31250000000000177636, 7.5,
 18.75000000000000355271, 2.29166666666666607455, 2.29166666666666607455,
 29.5, 2.375, 2.35416666666666651864,
 2.35416666666666651864},
 {  /* part 13 */
 8.58333333333333570181, 5.74999999999999822364, 10.62499999999999822364,
 5.31249999999999911182, 10.06249999999999822364, 9.1875,
 9.1875, 8.43750000000000355271, 8.43750000000000355271,
 8.16666666666666962726, 8.16666666666666962726, 8.31250000000000177636,
 8.31250000000000177636, 39.875, 32.875,
 93.60416666666667140362, 8.14583333333333570181, 8.14583333333333570181,
 112.75, 8.02083333333333570181, 7.87500000000000355271,
 7.87500000000000355271},
 {  /* part 14 */
 7.25, 4.75, 9.75,
 4.875, 8.875, 8.375,
 8.375, 7.5, 7.5,
 7.5, 7.5, 7.5,
 7.5, 32.875, 30.75,
 82.875, 7.125, 7.125,
 99.75, 7.25, 7.125,
 7.125},
 {  /* part 15 */
 21.79166666666666429819, 13.54166666666666607455, 25.9583333333333321491,
 12.97916666666666607455, 23.45833333333332859638, 20,
 20, 18.27083333333333570181, 18.27083333333333570181,
 18.8541666666666678509, 18.8541666666666678509, 18.75000000000000355271,
 18.75000000000000355271, 93.60416666666667140362, 82.875,
 313, 18.27083333333333570181, 18.27083333333333570181,
 256.5, 18.4791666666666678509, 17.9375,
 17.9375},
 {  /* part 16 */
 1.87499999999999955591, 1.16666666666666651864, 2.24999999999999955591,
 1.12499999999999977796, 2.47916666666666651864, 2.54166666666666740682,
 2.54166666666666740682, 2.50000000000000044409, 2.50000000000000044409,
 2.33333333333333303727, 2.33333333333333303727, 2.29166666666666607455,
 2.29166666666666607455, 8.14583333333333570181, 7.125,
 18.27083333333333570181, 2.5, 2.5,
 29.25, 2.24999999999999955591, 2.24999999999999955591,
 2.24999999999999955591},
 {  /* part 17 */
 1.87499999999999955591, 1.16666666666666651864, 2.24999999999999955591,
 1.12499999999999977796, 2.47916666666666651864, 2.54166666666666740682,
 2.54166666666666740682, 2.50000000000000044409, 2.50000000000000044409,
 2.33333333333333303727, 2.33333333333333303727, 2.29166666666666607455,
 2.29166666666666607455, 8.14583333333333570181, 7.125,
 18.27083333333333570181, 2.5, 2.5,
 29.25, 2.24999999999999955591, 2.24999999999999955591,
 2.24999999999999955591},
 {  /* part 18 */
 25.5, 16.125, 31.5,
 15.75, 33.375, 31.75,
 31.75, 30.25, 30.25,
 29.375, 29.375, 29.5,
 29.5, 112.75, 99.75,
 256.5, 29.25, 29.25,
 393.75, 28.5, 28.25,
 28.25},
 {  /* part 19 */
 1.9166666666666658525, 1.14583333333333325932, 2.24999999999999955591,
 1.12499999999999977796, 2.375, 2.41666666666666651864,
 2.41666666666666651864, 2.29166666666666607455, 2.29166666666666607455,
 2.39583333333333303727, 2.39583333333333303727, 2.375,
 2.375, 8.02083333333333570181, 7.25,
 18.4791666666666678509, 2.24999999999999955591, 2.24999999999999955591,
 28.5, 2.35416666666666651864, 2.33333333333333348136,
 2.33333333333333348136},
 {  /* part 20 */
 1.9166666666666658525, 1.12499999999999977796, 2.20833333333333303727,
 1.10416666666666651864, 2.35416666666666651864, 2.41666666666666651864,
 2.41666666666666651864, 2.29166666666666607455, 2.29166666666666607455,
 2.375, 2.375, 2.35416666666666651864,
 2.35416666666666651864, 7.87500000000000355271, 7.125,
 17.9375, 2.24999999999999955591, 2.24999999999999955591,
 28.25, 2.33333333333333348136, 2.33333333333333348136,
 2.33333333333333348136},
 {  /* part 21 */
 1.9166666666666658525, 1.12499999999999977796, 2.20833333333333303727,
 1.10416666666666651864, 2.35416666666666651864, 2.41666666666666651864,
 2.41666666666666651864, 2.29166666666666607455, 2.29166666666666607455,
 2.375, 2.375, 2.35416666666666651864,
 2.35416666666666651864, 7.87500000000000355271, 7.125,
 17.9375, 2.24999999999999955591, 2.24999999999999955591,
 28.25, 2.33333333333333348136, 2.33333333333333348136,
 2.33333333333333348136}},
{ /* agent 1 */
 {  /* part 0 */
 1.41666666666666651864, 0.99999999999999911182, 0.58333333333333170501,
 0.2916666666666658525, 0.5833333333333321491, 0.54166666666666474228,
 0.54166666666666474228, 0.62499999999999955591, 0.62499999999999955591,
 0.74999999999999888978, 0.74999999999999888978, 0.7916666666666658525,
 0.7916666666666658525, 0.62500000000000555112, 1.24999999999999955591,
 13.875, 0.70833333333333259318, 0.70833333333333259318,
 7.74999999999999822364, 5.12499999999999911182, 0.9166666666666658525,
 0.9166666666666658525},
 {  /* part 1 */
 0.99999999999999911182, 1.49999999999999888978, 0.54166666666666496432,
 0.27083333333333248216, 0.62499999999999888978, 0.66666666666666518637,
 0.66666666666666518637, 0.83333333333333259318, 0.83333333333333259318,
 0.91666666666666563046, 0.91666666666666563046, 0.97916666666666607455,
 0.97916666666666607455, 0.08333333333333325932, 1.49999999999999777955,
 18.45833333333332504367, 0.91666666666666563046, 0.91666666666666563046,
 9.37499999999999111822, 8.02083333333333037274, 1.0416666666666658525,
 1.0416666666666658525},
 {  /* part 2 */
 0.58333333333333170501, 0.54166666666666496432, 0.66666666666666518637,
 0.33333333333333259318, 0.33333333333333170501, 0.33333333333333126092,
 0.33333333333333126092, 0.33333333333333126092, 0.33333333333333126092,
 0.41666666666666474228, 0.41666666666666474228, 0.45833333333333170501,
 0.45833333333333170501, 0.79166666666666474228, 1.49999999999999555911,
 7.54166666666664831098, 0.33333333333333126092, 0.33333333333333126092,
 4.74999999999998223643, 2.45833333333332726411, 0.45833333333333170501,
 0.45833333333333170501},
 {  /* part 3 */
 0.2916666666666658525, 0.27083333333333248216, 0.33333333333333259318,
 0.16666666666666629659, 0.1666666666666658525, 0.16666666666666563046,
 0.16666666666666563046, 0.16666666666666563046, 0.16666666666666563046,
 0.20833333333333237114, 0.20833333333333237114, 0.2291666666666658525,
 0.2291666666666658525, 0.39583333333333237114, 0.74999999999999777955,
 3.77083333333332415549, 0.16666666666666563046, 0.16666666666666563046,
 2.37499999999999111822, 1.22916666666666363206, 0.2291666666666658525,
 0.2291666666666658525},
 {  /* part 4 */
 0.5833333333333321491, 0.62499999999999888978, 0.33333333333333170501,
 0.1666666666666658525, 0.70833333333333303727, 0.62499999999999911182,
 0.62499999999999911182, 0.66666666666666651864, 0.66666666666666651864,
 0.72916666666666607455, 0.72916666666666607455, 0.74999999999999955591,
 0.74999999999999955591, 0.64583333333333325932, 1.12499999999999777955,
 7.37499999999998845368, 0.72916666666666563046, 0.72916666666666563046,
 8.62499999999999111822, 3.24999999999999733546, 0.77083333333333259318,
 0.77083333333333259318},
 {  /* part 5 */
 0.54166666666666474228, 0.66666666666666518637, 0.33333333333333126092,
 0.16666666666666563046, 0.62499999999999911182, 0.95833333333333259318,
 0.95833333333333259318, 0.95833333333333303727, 0.95833333333333303727,
 0.91666666666666563046, 0.91666666666666563046, 0.95833333333333259318,
 0.95833333333333259318, 0.18750000000000133227, 1.12499999999999733546,
 6.24999999999999111822, 0.95833333333333303727, 0.95833333333333303727,
 8.99999999999998934186, 3.95833333333332992865, 0.99999999999999911182,
 0.99999999999999911182},
 {  /* part 6 */
 0.54166666666666474228, 0.66666666666666518637, 0.33333333333333126092,
 0.16666666666666563046, 0.62499999999999911182, 0.95833333333333259318,
 0.95833333333333259318, 0.95833333333333303727, 0.95833333333333303727,
 0.91666666666666563046, 0.91666666666666563046, 0.95833333333333259318,
 0.95833333333333259318, 0.18750000000000133227, 1.12499999999999733546,
 6.24999999999999111822, 0.95833333333333303727, 0.95833333333333303727,
 8.99999999999998934186, 3.95833333333332992865, 0.99999999999999911182,
 0.99999999999999911182},
 {  /* part 7 */
 0.62499999999999955591, 0.83333333333333259318, 0.33333333333333126092,
 0.16666666666666563046, 0.66666666666666651864, 0.95833333333333303727,
 0.95833333333333303727, 1.18750000000000133227, 1.18750000000000133227,
 1.08333333333333303727, 1.08333333333333303727, 1.10416666666666651864,
 1.10416666666666651864, 0.16666666666667451224, 1.12500000000000088818,
 8.60416666666667673269, 1.20833333333333392545, 1.20833333333333392545,
 11.00000000000000355271, 5.00000000000000088818, 1.16666666666666651864,
 1.16666666666666651864},
 {  /* part 8 */
 0.62499999999999955591, 0.83333333333333259318, 0.33333333333333126092,
 0.16666666666666563046, 0.66666666666666651864, 0.95833333333333303727,
 0.95833333333333303727, 1.18750000000000133227, 1.18750000000000133227,
 1.08333333333333303727, 1.08333333333333303727, 1.10416666666666651864,
 1.10416666666666651864, 0.16666666666667451224, 1.12500000000000088818,
 8.60416666666667673269, 1.20833333333333392545, 1.20833333333333392545,
 11.00000000000000355271, 5.00000000000000088818, 1.16666666666666651864,
 1.16666666666666651864},
 {  /* part 9 */
 0.74999999999999888978, 0.91666666666666563046, 0.41666666666666474228,
 0.20833333333333237114, 0.72916666666666607455, 0.91666666666666563046,
 0.91666666666666563046, 1.08333333333333303727, 1.08333333333333303727,
 1.33333333333333303727, 1.33333333333333303727, 1.29166666666666651864,
 1.29166666666666651864, 0.20833333333333947657, 1.49999999999999955591,
 10.93750000000000355271, 1.16666666666666607455, 1.16666666666666607455,
 11.62499999999999822364, 5.60416666666666607455, 1.375,
 1.375},
 {  /* part 10 */
 0.74999999999999888978, 0.91666666666666563046, 0.41666666666666474228,
 0.20833333333333237114, 0.72916666666666607455, 0.91666666666666563046,
 0.91666666666666563046, 1.08333333333333303727, 1.08333333333333303727,
 1.33333333333333303727, 1.33333333333333303727, 1.29166666666666651864,
 1.29166666666666651864, 0.20833333333333947657, 1.49999999999999955591,
 10.93750000000000355271, 1.16666666666666607455, 1.16666666666666607455,
 11.62499999999999822364, 5.60416666666666607455, 1.375,
 1.375},
 {  /* part 11 */
 0.7916666666666658525, 0.97916666666666607455, 0.45833333333333170501,
 0.2291666666666658525, 0.74999999999999955591, 0.95833333333333259318,
 0.95833333333333259318, 1.10416666666666651864, 1.10416666666666651864,
 1.29166666666666651864, 1.29166666666666651864, 1.35416666666666696273,
 1.35416666666666696273, 0.45833333333333903248, 1.62500000000000044409,
 11.41666666666667495633, 1.16666666666666607455, 1.16666666666666607455,
 12.25000000000000177636, 5.75000000000000088818, 1.39583333333333348136,
 1.39583333333333348136},
 {  /* part 12 */
 0.7916666666666658525, 0.97916666666666607455, 0.45833333333333170501,
 0.2291666666666658525, 0.74999999999999955591, 0.95833333333333259318,
 0.95833333333333259318, 1.10416666666666651864, 1.10416666666666651864,
 1.29166666666666651864, 1.29166666666666651864, 1.35416666666666696273,
 1.35416666666666696273, 0.45833333333333903248, 1.62500000000000044409,
 11.41666666666667495633, 1.16666666666666607455, 1.16666666666666607455,
 12.25000000000000177636, 5.75000000000000088818, 1.39583333333333348136,
 1.39583333333333348136},
 {  /* part 13 */
 0.62500000000000555112, 0.08333333333333325932, 0.79166666666666474228,
 0.39583333333333237114, 0.64583333333333325932, 0.18750000000000133227,
 0.18750000000000133227, 0.16666666666667451224, 0.16666666666667451224,
 0.20833333333333947657, 0.20833333333333947657, 0.45833333333333903248,
 0.45833333333333903248, 7.37500000000001776357, 2.75000000000001065814,
 3.22916666666673002339, 0.18750000000000555112, 0.18750000000000555112,
 7.87500000000004263256, -4.12499999999998223643, 0.33333333333334080884,
 0.33333333333334080884},
 {  /* part 14 */
 1.24999999999999955591, 1.49999999999999777955, 1.49999999999999555911,
 0.74999999999999777955, 1.12499999999999777955, 1.12499999999999733546,
 1.12499999999999733546, 1.12500000000000088818, 1.12500000000000088818,
 1.49999999999999955591, 1.49999999999999955591, 1.62500000000000044409,
 1.62500000000000044409, 2.75000000000001065814, 5.25,
 24.12500000000001065814, 1.12499999999999955591, 1.12499999999999955591,
 16.5, 6.87500000000000088818, 1.62500000000000044409,
 1.62500000000000044409},
 {  /* part 15 */
 13.875, 18.45833333333332504367, 7.54166666666664831098,
 3.77083333333332415549, 7.37499999999998845368, 6.24999999999999111822,
 6.24999999999999111822, 8.60416666666667673269, 8.60416666666667673269,
 10.93750000000000355271, 10.93750000000000355271, 11.41666666666667495633,
 11.41666666666667495633, 3.22916666666673002339, 24.12500000000001065814,
 320.00000000000011368684, 10.35416666666667140362, 10.35416666666667140362,
 109.00000000000004263256, 97.06250000000001421085, 12.35416666666667140362,
 12.35416666666667140362},
 {  /* part 16 */
 0.70833333333333259318, 0.91666666666666563046, 0.33333333333333126092,
 0.16666666666666563046, 0.72916666666666563046, 0.95833333333333303727,
 0.95833333333333303727, 1.20833333333333392545, 1.20833333333333392545,
 1.16666666666666607455, 1.16666666666666607455, 1.16666666666666607455,
 1.16666666666666607455, 0.18750000000000555112, 1.12499999999999955591,
 10.35416666666667140362, 1.33333333333333303727, 1.33333333333333303727,
 11.49999999999999822364, 5.4583333333333321491, 1.24999999999999955591,
 1.24999999999999955591},
 {  /* part 17 */
 0.70833333333333259318, 0.91666666666666563046, 0.33333333333333126092,
 0.16666666666666563046, 0.72916666666666563046, 0.95833333333333303727,
 0.95833333333333303727, 1.20833333333333392545, 1.20833333333333392545,
 1.16666666666666607455, 1.16666666666666607455, 1.16666666666666607455,
 1.16666666666666607455, 0.18750000000000555112, 1.12499999999999955591,
 10.35416666666667140362, 1.33333333333333303727, 1.33333333333333303727,
 11.49999999999999822364, 5.4583333333333321491, 1.24999999999999955591,
 1.24999999999999955591},
 {  /* part 18 */
 7.74999999999999822364, 9.37499999999999111822, 4.74999999999998223643,
 2.37499999999999111822, 8.62499999999999111822, 8.99999999999998934186,
 8.99999999999998934186, 11.00000000000000355271, 11.00000000000000355271,
 11.62499999999999822364, 11.62499999999999822364, 12.25000000000000177636,
 12.25000000000000177636, 7.87500000000004263256, 16.5,
 109.00000000000004263256, 11.49999999999999822364, 11.49999999999999822364,
 135.75, 52, 12.50000000000000177636,
 12.50000000000000177636},
 {  /* part 19 */
 5.12499999999999911182, 8.02083333333333037274, 2.45833333333332726411,
 1.22916666666666363206, 3.24999999999999733546, 3.95833333333332992865,
 3.95833333333332992865, 5.00000000000000088818, 5.00000000000000088818,
 5.60416666666666607455, 5.60416666666666607455, 5.75000000000000088818,
 5.75000000000000088818, -4.12499999999998223643, 6.87500000000000088818,
 97.06250000000001421085, 5.4583333333333321491, 5.4583333333333321491,
 52, 46.6875, 6.20833333333333392545,
 6.20833333333333392545},
 {  /* part 20 */
 0.9166666666666658525, 1.0416666666666658525, 0.45833333333333170501,
 0.2291666666666658525, 0.77083333333333259318, 0.99999999999999911182,
 0.99999999999999911182, 1.16666666666666651864, 1.16666666666666651864,
 1.375, 1.375, 1.39583333333333348136,
 1.39583333333333348136, 0.33333333333334080884, 1.62500000000000044409,
 12.35416666666667140362, 1.24999999999999955591, 1.24999999999999955591,
 12.50000000000000177636, 6.20833333333333392545, 1.50000000000000044409,
 1.50000000000000044409},
 {  /* part 21 */
 0.9166666666666658525, 1.0416666666666658525, 0.45833333333333170501,
 0.2291666666666658525, 0.77083333333333259318, 0.99999999999999911182,
 0.99999999999999911182, 1.16666666666666651864, 1.16666666666666651864,
 1.375, 1.375, 1.39583333333333348136,
 1.39583333333333348136, 0.33333333333334080884, 1.62500000000000044409,
 12.35416666666667140362, 1.24999999999999955591, 1.24999999999999955591,
 12.50000000000000177636, 6.20833333333333392545, 1.50000000000000044409,
 1.50000000000000044409}}};

/* number of each part in a living bovid */
int b[NPART] = {
  2 /*half-mandible*/,
  2 /*atlas/axis*/,
  2 /*half-pelv*/,
  1 /*sacrum*/,
  2 /*scapula*/,
  2 /*humeri_prox*/,
  2 /*humeri_dist*/,
  2 /*radiocubiti prox*/,
  2 /*radiocubiti dist*/,
  2 /*femora prox*/,
  2 /*femora dist*/,
  2 /*tibia prox*/,
  2 /*tibia dist*/,
  5 /*cerv_vert*/,
  6 /*lumbar_vert*/,
  28 /*ribs*/,
  2 /*metacarpals prox*/,
  2 /*metacarpals dist*/,
  24 /*phalanges*/,
  8 /*tarsals*/,
  2 /*metatarsals prox*/,
  2 /*metatarsals dist*/
};

/* bone density (Lyman 1985) */
double density[NPART] = {
0.57,  /* half-mandibles */
0.145, /* axis/axis */
0.27,  /* half-pelvis */
0.19,  /* sacrum */
0.36,  /* scapula */
0.24,  /* humerus_prox */
0.39,  /* humerus_dist */
0.36,  /* radiocubiti_prox */
0.435, /* radiocubiti_dist */
0.36,  /* femur_prox */
0.28,  /* femur_dist */
0.30,  /* tibia_prox */
0.50,  /* tibia_dist */
0.19,  /* cervical_vert */
0.29,  /* lumbar_vert */
0.40,  /* ribs */
0.56,  /* metacarpal_prox */
0.49,  /* metacarpal_dist */
0.31,  /* phalanges */
0.56,  /* tarsals */
0.55,  /* metatarsal_prox */
0.46   /* metatarsal_dist */         
};

char *label[NPART] = {"half-mandibles", "axis/axis", "half-pelvis",
"sacrum", "scapula", "humerus_prox", "humerus_dist",
"radiocubiti_prox", "radiocubiti_dist", "femur_prox", "femur_dist",
"tibia_prox", "tibia_dist", "cervical_vert", "lumbar_vert", "ribs",
"metacarpal_prox", "metacarpal_dist", "phalanges", "tarsals",
"metatarsal_prox", "metatarsal_dist"};

/* archeological data */
#define NDATA 101
/* 0'th data set is the Makapansgat fauna */
/* 100 data sets simulated w/ Hadza data (in conformity wit */
/* Makapansgat.  alpha=0.4 lambda=1000 beta=1               */
int yy[NDATA][22] = {
{369,45,107,16,126,33,336,279,114,28,56,64,119,47,30,66,129,161,47,136,
107, 110},  /* makapansgat fauna */
{ 635, 195, 334, 104, 469, 340, 471, 469, 569, 498, 392, 450, 611,
765, 1101, 7785, 603, 587, 5285, 2972, 632, 573}, 
{ 629, 202, 385, 136, 484, 330, 499, 492, 556, 493, 398, 425, 586,
776, 1163, 8011, 614, 552, 5112, 2972, 615, 582}, 
{ 621, 185, 347, 117, 445, 353, 509, 474, 527, 499, 405, 405, 594,
835, 1186, 7640, 618, 588, 5130, 2917, 599, 574}, 
{ 602, 192, 362, 132, 458, 346, 463, 443, 496, 470, 411, 439, 573,
776, 1145, 7780, 575, 530, 4749, 2945, 618, 565}, 
{ 575, 187, 341, 118, 426, 321, 505, 447, 520, 464, 422, 450, 610,
763, 1131, 7475, 629, 572, 4915, 2919, 626, 542}, 
{ 633, 215, 359, 114, 455, 324, 481, 454, 513, 475, 361, 436, 605,
785, 1138, 7388, 626, 545, 5002, 2976, 622, 597}, 
{ 637, 173, 345, 128, 459, 305, 467, 453, 516, 488, 377, 426, 612,
793, 1125, 7829, 572, 545, 5132, 2932, 616, 544}, 
{ 601, 207, 362, 91, 389, 322, 473, 472, 533, 447, 357, 385, 525, 736,
1077, 7680, 592, 558, 4578, 2902, 560, 524}, 
{ 592, 199, 346, 126, 425, 309, 490, 425, 494, 480, 375, 380, 560,
770, 1073, 7840, 586, 529, 4704, 2857, 578, 569}, 
{ 609, 199, 381, 111, 473, 332, 509, 487, 536, 481, 405, 412, 561,
768, 1173, 7664, 587, 596, 4964, 2962, 634, 563}, 
{ 625, 179, 362, 110, 433, 306, 460, 458, 521, 472, 350, 408, 566,
771, 1075, 7477, 557, 517, 4949, 2946, 585, 525}, 
{ 584, 193, 369, 122, 421, 320, 483, 476, 548, 472, 396, 404, 597,
791, 1048, 7359, 598, 549, 4902, 2875, 581, 552}, 
{ 623, 164, 329, 128, 451, 323, 451, 446, 500, 467, 410, 421, 577,
719, 1112, 7648, 597, 566, 5036, 2901, 626, 595}, 
{ 637, 205, 379, 122, 459, 351, 495, 504, 550, 487, 393, 452, 598,
799, 1132, 7766, 638, 573, 5032, 2970, 623, 597}, 
{ 637, 194, 355, 126, 465, 335, 504, 486, 521, 484, 412, 446, 589,
768, 1081, 7635, 600, 567, 5062, 2980, 632, 560}, 
{ 619, 197, 349, 122, 397, 337, 470, 455, 530, 473, 390, 445, 608,
748, 1112, 7644, 623, 568, 4776, 2963, 633, 575}, 
{ 612, 199, 344, 112, 448, 330, 478, 478, 552, 471, 390, 405, 566,
766, 1141, 7574, 606, 576, 5056, 2948, 600, 582}, 
{ 607, 179, 355, 113, 449, 310, 499, 463, 526, 452, 416, 403, 556,
753, 1082, 7450, 596, 538, 4891, 2921, 598, 512}, 
{ 591, 219, 317, 103, 478, 308, 444, 455, 538, 450, 365, 405, 573,
797, 1034, 7588, 603, 562, 4909, 2971, 578, 515}, 
{ 649, 196, 360, 122, 443, 372, 507, 518, 562, 458, 409, 435, 584,
751, 1059, 7513, 667, 622, 5209, 2957, 640, 573}, 
{ 632, 186, 353, 113, 455, 330, 489, 452, 549, 519, 432, 457, 578,
726, 1116, 7729, 621, 579, 4856, 2950, 612, 585}, 
{ 575, 204, 372, 118, 455, 331, 495, 463, 563, 483, 435, 436, 571,
813, 1109, 7404, 634, 614, 5070, 2882, 612, 565}, 
{ 618, 208, 380, 125, 456, 365, 476, 464, 496, 485, 382, 400, 566,
789, 1182, 7883, 626, 576, 5075, 2942, 627, 581}, 
{ 592, 202, 347, 139, 412, 326, 469, 465, 528, 470, 398, 408, 606,
784, 1147, 7661, 592, 551, 4974, 2922, 599, 579}, 
{ 607, 202, 383, 150, 446, 323, 478, 489, 521, 499, 387, 463, 569,
857, 1110, 7787, 627, 576, 5154, 2988, 603, 591}, 
{ 645, 165, 375, 127, 472, 325, 487, 448, 498, 477, 396, 436, 570,
802, 1098, 8000, 588, 564, 5044, 2932, 604, 584}, 
{ 603, 182, 315, 103, 437, 286, 439, 477, 547, 482, 377, 416, 589,
787, 1086, 7538, 606, 592, 4868, 2887, 614, 540}, 
{ 618, 198, 356, 126, 445, 332, 461, 507, 514, 476, 348, 409, 544,
763, 1118, 7662, 585, 572, 4890, 2903, 620, 559}, 
{ 639, 238, 337, 128, 440, 370, 495, 468, 570, 487, 398, 429, 590,
801, 1130, 7671, 641, 568, 5016, 2914, 654, 561}, 
{ 658, 195, 372, 144, 484, 336, 525, 455, 549, 486, 417, 434, 636,
784, 1167, 7650, 617, 595, 5092, 2974, 658, 591}, 
{ 641, 170, 351, 121, 466, 332, 516, 477, 551, 514, 391, 470, 630,
838, 1097, 7478, 647, 592, 5222, 2956, 648, 600}, 
{ 624, 201, 360, 112, 435, 311, 497, 437, 515, 462, 376, 420, 566,
787, 1093, 7817, 578, 563, 4851, 2893, 569, 552}, 
{ 615, 206, 358, 131, 431, 327, 507, 464, 560, 487, 404, 428, 606,
792, 1170, 8017, 612, 600, 5182, 2964, 665, 578}, 
{ 618, 197, 332, 105, 461, 312, 476, 466, 543, 505, 396, 422, 587,
766, 1059, 7698, 628, 574, 5087, 2915, 620, 600}, 
{ 614, 190, 340, 121, 445, 323, 495, 506, 572, 496, 392, 428, 596,
764, 1077, 7654, 623, 591, 5104, 2987, 634, 582}, 
{ 594, 201, 351, 90, 452, 333, 467, 437, 507, 472, 381, 398, 553, 775,
1042, 7424, 593, 544, 4723, 2988, 586, 550}, 
{ 598, 214, 362, 110, 442, 314, 454, 464, 571, 488, 414, 425, 578,
780, 1146, 7786, 627, 590, 5122, 2976, 651, 570}, 
{ 590, 198, 325, 120, 449, 324, 484, 461, 554, 502, 366, 442, 572,
751, 993, 7478, 593, 582, 4874, 3025, 629, 549}, 
{ 625, 171, 374, 112, 477, 355, 476, 491, 559, 523, 401, 448, 596,
785, 1113, 7644, 607, 602, 5097, 2983, 636, 568}, 
{ 640, 191, 359, 123, 455, 335, 480, 460, 556, 496, 404, 446, 614,
786, 1058, 7595, 612, 588, 5094, 2925, 613, 562}, 
{ 614, 190, 335, 124, 439, 338, 483, 518, 577, 492, 390, 413, 562,
784, 1072, 7313, 636, 616, 5051, 2942, 643, 573}, 
{ 603, 180, 376, 122, 423, 294, 462, 432, 539, 445, 356, 421, 568,
808, 1132, 7642, 552, 542, 4810, 2932, 577, 513}, 
{ 565, 195, 362, 123, 473, 331, 530, 472, 563, 500, 383, 429, 593,
764, 1094, 7187, 650, 586, 5140, 2937, 616, 568}, 
{ 625, 218, 356, 121, 451, 323, 490, 467, 519, 463, 379, 414, 568,
798, 1165, 8039, 578, 573, 4966, 2953, 612, 570}, 
{ 615, 175, 352, 121, 450, 337, 535, 484, 537, 490, 376, 437, 588,
758, 1063, 7250, 629, 586, 4987, 3027, 612, 534}, 
{ 619, 190, 339, 119, 461, 340, 482, 475, 519, 486, 379, 403, 578,
798, 1137, 7825, 580, 538, 4929, 2970, 641, 555}, 
{ 564, 183, 337, 116, 475, 301, 492, 449, 521, 463, 391, 440, 581,
743, 1082, 7254, 592, 560, 4980, 2996, 610, 549}, 
{ 678, 209, 366, 120, 453, 326, 452, 465, 508, 454, 393, 432, 540,
803, 1112, 7744, 608, 594, 4944, 2951, 598, 547}, 
{ 594, 189, 353, 119, 434, 350, 471, 461, 549, 477, 371, 392, 592,
772, 1123, 7673, 622, 581, 4818, 2959, 603, 581}, 
{ 622, 202, 342, 102, 486, 337, 505, 472, 576, 503, 419, 428, 577,
779, 1081, 7968, 644, 603, 5077, 3014, 652, 592}, 
{ 555, 214, 329, 105, 452, 342, 452, 498, 512, 450, 397, 386, 561,
778, 1093, 7496, 573, 579, 4793, 2935, 600, 492}, 
{ 628, 171, 359, 126, 446, 326, 493, 459, 545, 484, 403, 426, 593,
778, 1166, 7287, 601, 581, 5082, 2964, 626, 562}, 
{ 638, 189, 332, 123, 446, 315, 503, 494, 589, 483, 371, 421, 613,
751, 1105, 7492, 631, 611, 5164, 2905, 609, 579}, 
{ 635, 211, 391, 109, 455, 325, 498, 483, 529, 472, 417, 404, 594,
808, 1143, 7928, 588, 576, 5090, 2972, 638, 578}, 
{ 578, 191, 355, 113, 457, 319, 489, 454, 498, 452, 378, 411, 561,
766, 1091, 7837, 600, 538, 4820, 2884, 584, 525}, 
{ 627, 205, 315, 130, 472, 296, 493, 474, 518, 449, 372, 407, 572,
776, 1029, 7499, 578, 561, 4816, 2910, 599, 558}, 
{ 630, 183, 359, 116, 456, 309, 503, 467, 537, 447, 377, 417, 576,
758, 1116, 7662, 605, 562, 4921, 2925, 603, 551}, 
{ 606, 186, 386, 112, 392, 325, 461, 457, 494, 460, 392, 417, 555,
735, 1045, 7628, 598, 537, 4627, 2933, 590, 530}, 
{ 665, 192, 331, 126, 449, 311, 469, 446, 516, 442, 402, 428, 588,
773, 1136, 7557, 590, 556, 4965, 2898, 609, 554}, 
{ 597, 182, 366, 116, 430, 349, 495, 446, 523, 486, 392, 417, 577,
793, 1138, 7757, 583, 564, 4953, 2962, 600, 540}, 
{ 578, 202, 367, 126, 416, 324, 510, 475, 538, 491, 391, 453, 575,
755, 1197, 7552, 624, 569, 4984, 3008, 622, 567}, 
{ 620, 202, 361, 132, 417, 310, 439, 419, 482, 437, 355, 374, 515,
774, 1060, 7709, 544, 510, 4576, 2920, 534, 500}, 
{ 584, 199, 328, 117, 426, 346, 448, 477, 543, 459, 385, 428, 563,
750, 1081, 7358, 610, 562, 4785, 2925, 592, 551}, 
{ 603, 175, 335, 137, 434, 298, 464, 481, 521, 477, 409, 433, 551,
769, 1095, 7215, 582, 563, 5121, 2934, 593, 544}, 
{ 631, 197, 377, 125, 459, 343, 446, 444, 511, 471, 375, 412, 548,
767, 1077, 7847, 567, 522, 4885, 2949, 608, 528}, 
{ 651, 203, 365, 130, 470, 319, 473, 478, 521, 501, 377, 436, 570,
834, 1152, 7813, 554, 543, 4932, 2965, 619, 575}, 
{ 614, 193, 326, 114, 434, 339, 481, 456, 493, 466, 408, 419, 562,
786, 1034, 7499, 604, 535, 4779, 2944, 604, 574}, 
{ 661, 188, 388, 132, 479, 332, 511, 507, 570, 480, 425, 421, 572,
809, 1138, 7812, 650, 568, 4976, 3018, 590, 567}, 
{ 658, 217, 364, 107, 450, 321, 478, 494, 563, 502, 397, 414, 570,
782, 1143, 7747, 624, 571, 5237, 2959, 628, 561}, 
{ 648, 200, 373, 151, 490, 348, 533, 500, 556, 499, 391, 443, 609,
816, 1147, 7794, 642, 594, 5101, 2933, 621, 583}, 
{ 652, 218, 358, 115, 458, 357, 493, 497, 524, 488, 416, 420, 593,
823, 1137, 7757, 623, 573, 5119, 2994, 656, 580}, 
{ 652, 217, 347, 109, 461, 338, 492, 474, 542, 472, 383, 424, 593,
771, 1110, 7544, 628, 609, 5047, 2968, 647, 582}, 
{ 605, 202, 379, 118, 483, 334, 513, 470, 576, 490, 410, 449, 604,
822, 1115, 7703, 606, 602, 5142, 2969, 634, 581}, 
{ 585, 183, 334, 121, 481, 349, 471, 481, 550, 510, 416, 436, 571,
711, 1042, 7309, 628, 584, 5008, 2947, 644, 585}, 
{ 575, 198, 312, 125, 435, 340, 493, 505, 562, 516, 401, 431, 606,
818, 1121, 7535, 627, 607, 5203, 3033, 669, 614}, 
{ 605, 215, 337, 103, 438, 333, 533, 468, 538, 484, 394, 411, 572,
751, 1067, 7472, 622, 595, 4990, 2951, 622, 571}, 
{ 584, 202, 339, 137, 436, 312, 457, 459, 513, 487, 380, 395, 549,
779, 1049, 7642, 613, 561, 4724, 2838, 596, 534}, 
{ 594, 171, 314, 125, 435, 305, 452, 460, 527, 461, 389, 397, 554,
773, 1117, 7333, 608, 593, 4705, 2935, 603, 543}, 
{ 574, 192, 320, 120, 466, 317, 459, 459, 504, 459, 374, 438, 592,
751, 1112, 7954, 604, 563, 4923, 2934, 593, 569}, 
{ 664, 183, 388, 136, 467, 331, 486, 478, 534, 511, 433, 434, 602,
817, 1182, 7911, 620, 560, 5213, 2959, 637, 585}, 
{ 615, 173, 348, 119, 422, 327, 489, 481, 545, 503, 396, 441, 599,
735, 1161, 7884, 613, 591, 4917, 2896, 616, 582}, 
{ 575, 190, 338, 119, 424, 323, 474, 443, 495, 510, 404, 407, 554,
868, 1110, 7796, 578, 581, 4829, 2908, 633, 553}, 
{ 587, 220, 331, 107, 455, 320, 459, 461, 532, 462, 394, 397, 572,
751, 1087, 7588, 606, 564, 4887, 2918, 586, 546}, 
{ 658, 222, 353, 111, 446, 359, 503, 436, 517, 479, 391, 438, 597,
861, 1083, 7602, 626, 584, 5203, 2922, 593, 569}, 
{ 616, 202, 354, 138, 444, 320, 496, 475, 550, 467, 390, 424, 577,
741, 1176, 7593, 609, 549, 4928, 2964, 630, 580}, 
{ 665, 205, 363, 103, 420, 325, 480, 442, 510, 487, 391, 431, 569,
775, 1072, 7479, 600, 571, 4850, 2974, 652, 566}, 
{ 622, 199, 360, 109, 473, 330, 502, 503, 543, 469, 422, 440, 601,
789, 1147, 7683, 597, 586, 4993, 2997, 652, 627}, 
{ 646, 201, 351, 123, 431, 318, 464, 479, 567, 476, 400, 405, 599,
723, 989, 7553, 602, 564, 4924, 2961, 598, 542}, 
{ 639, 192, 346, 121, 462, 321, 502, 458, 546, 452, 392, 422, 603,
794, 1039, 7458, 611, 576, 4981, 2918, 611, 585}, 
{ 629, 190, 366, 127, 447, 320, 504, 467, 543, 479, 356, 438, 622,
747, 1136, 7777, 605, 583, 4952, 3003, 612, 555}, 
{ 646, 186, 317, 109, 431, 353, 513, 462, 534, 498, 402, 420, 583,
782, 1123, 7446, 640, 583, 4950, 2973, 618, 591}, 
{ 622, 198, 346, 127, 421, 306, 461, 472, 514, 486, 376, 404, 575,
751, 1100, 7891, 615, 598, 4949, 2904, 637, 540}, 
{ 641, 181, 377, 128, 419, 329, 473, 456, 512, 475, 395, 401, 589,
837, 1101, 7828, 619, 576, 4944, 2953, 600, 567}, 
{ 572, 173, 340, 119, 438, 338, 447, 486, 534, 500, 391, 415, 582,
747, 1094, 7716, 581, 548, 4990, 2942, 639, 551}, 
{ 600, 194, 343, 122, 437, 310, 445, 463, 504, 460, 386, 404, 531,
775, 1156, 7590, 567, 527, 4789, 2910, 574, 529}, 
{ 594, 170, 366, 118, 461, 325, 512, 474, 557, 484, 437, 435, 580,
763, 1099, 7159, 641, 590, 5155, 2982, 610, 564}, 
{ 633, 196, 354, 121, 455, 362, 504, 486, 572, 464, 393, 436, 607,
764, 1107, 7357, 619, 598, 4993, 3003, 618, 588}, 
{ 615, 188, 368, 122, 442, 317, 502, 465, 547, 502, 388, 478, 605,
765, 1066, 7419, 601, 560, 5198, 2928, 641, 589}, 
{ 622, 202, 353, 120, 432, 333, 499, 472, 534, 494, 410, 435, 603,
757, 1063, 7520, 658, 613, 5179, 2963, 613, 578}, 
{ 642, 184, 342, 113, 468, 328, 484, 488, 511, 459, 413, 409, 582,
791, 1144, 7732, 580, 563, 4984, 2961, 599, 575}}; 
#endif 
 
#define FTOL 1.0e-6
int nagent=NAGENT;
int rdim=NPART, npart=NPART;
int nparam=NPARAM;
int **lump=NULL, *y;
real ***F, **m, *sensitivity;
int verbose=1;

real p0[NPARAM];                   /* initial vector */

real func(real *x);

void usage(void)
{
  fprintf(stderr,"\nusage: bone [-q] [<which_data>]\n");
  exit(1);
}

/* we want to maximize lnL, but amoeba is a minimizer.  So the */
/* objective function is -lnL                                  */
real func(real *x)
{
  return(-lnL(x));
}

/* correlation  j,k for agent i */ 
real correlation(int i, int j, int k)
{
  return(F[i][j][k] / sqrt(F[i][j][j] * F[i][k][k]));
}

/* used by zeroin to find scale factor for sensitivities */
double sfun(double x)
{
  int i;
  double s=0.0, t=0.0;

  for(i=0; i<NPART; i++)
  {
    s += exp(-x/density[i]) * b[i];
    t += b[i];
  }
  return(0.5 - s/t);
}

void main(int argc, char **argv)
{
  int i, j, k, l, nfunc, ndim=NPARAM, pass, converged;
  int which_data = 0;
  real *x, *yyy, **p, **c, *alpha;
  real eps = 0.1, scale_factor;
  real **Fmean;
  char buff[20];

  for(i=1; i<argc; i++)
  {
    if(argv[i][0] == '-')
    {
      switch(argv[i][1])
      {
      case 'q':
	verbose = 0;
	break;
      default:
	usage();
      }
    }else
      which_data = strtol(argv[i], NULL, 10);
  }

  /* initialize random number generator */
  srand48((int) time((time_t *) 0));

  /* initial parameter vector */
  p0[0] = drand48();               /* alpha  */
  p0[1] = drand48() * 2000.0;      /* lambda */
#if ATTRITION  
  p0[2] = drand48();
#endif

  /* allocate F, Fmean */
  Fmean = (real **) alloc2d(rdim, rdim, sizeof(real));
  if(Fmean == NULL)
    error("main: alloc2d");
  F = (real ***) mustalloc(nagent * sizeof(real**));
  for(i=0; i<nagent; i++)
  {
    F[i] = (real**) alloc2d(rdim, rdim, sizeof(real));
    if(F[i]==NULL)
      error("main: alloc2d");
  }

  /* set F = FF */
  for(i=0; i<nagent; i++)
    for(j=0; j<rdim; j++)
      for(k=0; k<rdim; k++)
	F[i][j][k] = FF[i][j][k];

  /* get mean F */
  alpha = p0 + (ATTRITION ? 2 : 1);
  getFmean(Fmean, F, rdim, alpha, nagent);

  /* allocations */
  y = (int *) mustalloc(rdim * sizeof(int));
  sensitivity = (real *) mustalloc(rdim * sizeof(real));
  m = (real **) alloc2d(nagent, rdim, sizeof(real));
  c = (real **) alloc2d(rdim, rdim, sizeof(real));
  if(m==NULL || c==NULL)
  {
    fprintf(stderr,"\nmain: alloc2d\n");
    exit(1);
  }

  /* set sensitivities */
  /****************************************************************
  scale_factor is set so that when beta=1, half the bones in a whole
  animal survive.
  ****************************************************************/
  scale_factor = zeroin(0.0, 10.0, sfun, 0.0001);
  if(verbose)
    printf("\nscale_factor = %f", scale_factor);
  for(i=0; i<rdim; i++)
    sensitivity[i] = scale_factor/density[i];

  /* set y = yy[i].  Select a data set here. */
  if(which_data < 0 || which_data >= NDATA)
  {
    fprintf(stderr,"\nError: which_data=%d.\n", which_data);
    exit(1);
  }
  for(i=0; i<rdim; i++)
    y[i] = yy[which_data][i];

  /* set m = mm */
  for(i=0; i<nagent; i++)
    m[i] = mm[i];

  /* check correlations */
  lump = id_mat(npart);
  do{
    l = rdim;
    xTax(lump, Fmean, c, npart, rdim);  /* quadratic form */
    for(j=0; j<rdim && rdim==l; j++)
      for(k=0; k<j && rdim==l; k++)
      {
	if(fabs( c[j][k] ) > sqrt(c[j][j]*c[k][k]) *  0.91)
	  dolump(j,k);      /* resets rdim */
      }
  }while(rdim < l);
  free2d((void **) c);

  if(verbose)
  {
    printf("\nlump matrix:");
    for(i=0; i<npart; i++)
    {
      putchar('\n');
      for(j=0; j<rdim; j++)
	printf("%d ", lump[i][j]);
      printf("%s", label[i]);
    }
  }

  if(verbose)
  {
    printf("\nrdim: %d", rdim);
    printf("\nnagent: %d", nagent);
    printf("\nnparam: %d", nparam);
    printf("\np0:");
    for(i=0; i<nparam; i++)
      printf(" %f", p0[i]);
  }
  printf("\nusing data set %d", which_data);

  x = (real *) mustalloc(nparam * sizeof(real) );
  yyy = (real *) mustalloc( (nparam+1) * sizeof(real) );
  p = (real **) alloc2d((nparam+1), nparam, sizeof(real) );
  if(p==NULL)
  {
    fprintf(stderr,"\nmain: alloc2d\n");
    exit(1);
  }
  for(pass=1; pass<=2; pass++)
  {
    if(verbose)
    {
      printf("\n\nPASS %d...", pass);
      fflush(stdout);
    }
    for (i = 0; i < nparam+1; i++)
    {
      for (j = 0; j<  nparam; j++)
	x[j] = p[i][j] = p0[j]*(1.0 + eps * (i==j ? 1.0 : -1.0));
      yyy[i] = func(x);
    }
    nfunc = amoeba(p, yyy, ndim, FTOL, func);
    if(nfunc < 0)
    {
      if(verbose)
	printf("\nNO CONVERGENCE in amoeba pass %d", pass);
      nfunc = -nfunc;
      converged = 0;
    }else
    {
      if(verbose)
	printf("\namoeba pass %d converged", pass);
      converged = 1;
    }
    if(verbose)
      printf("\n%d function evaluations", nfunc);
    for(j=0; j<nparam; j++)
    {
      p0[j] = 0.0;
      for(i=0; i < (nparam+1); i++)
	p0[j] += p[i][j];
      p0[j] /= (double) nparam+1;
    }
  } /* end pass loop */
  if(verbose)
  {
    printf("\nFinal simplex:");
    printf("\n\n%3s", "i");
    for(j=0; j<nparam; j++)
    {
      sprintf(buff,"p[i][%d]",j); 
      printf(" %12s", buff);
    }
    printf("%14s\n", "function");
    for (i = 0; i< (nparam+1); i++)
    {
      printf("\n%3d ", i);
      for (j = 0; j < nparam; j++)
	printf("%12.6f ", p[i][j]);
      printf("%12.6f", yyy[i]);
    }
  }

  if(converged)
  {
    printf("\nEstimate: ");
    for(i=0; i<nparam; i++)
      printf(" %12.6f", p0[i]);
    putchar('\n');
    exit(0);
  }
  fprintf(stderr,"\nNo convergence\n");
  exit(1);
}
